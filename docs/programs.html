<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Programs</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="header">
        <a href = "home.html">
            <img src = "images/logo.png" alt = "Energy FM 106.3 Naga Logo" class = "logo">
        </a>

        <input type="checkbox" id="menu-toggle">
        <label for="menu-toggle" class="menu-icon">&#9776;</label>

        <div class="dropdown-menu">
            <a href="about.html">About</a>
            <a href="profiles.html">Profiles</a>
            <a href="programs.html">Programs</a>
            <a href="stream.html">Stream</a>
            <a href="news.html">News</a>
        </div>

        <div class="header-overlay">
            <h1>ENERGY PROGRAMS</h1>
            <p class = "intro-programs">Pangga, may ENERGY ka pa ba? Tara na! Dive into the world of ENERGY FM where all your favorite programs are in ONE place!<br>
            From music that keeps you vibing to live broadcasts and talk shows that keep you company, everything is here. Check out each program's schedule and 
            anchors so you'll always know what's airing next!</p>
        </div>
    </header>

    <div class = "break-box"></div>

    <section class="content">

        <div class="top-bar">
            <h2>ALL PROGRAMS</h2>

            <select id="filter-select" class="filter-btn">
              <option value="title">TITLE (A–Z)</option>
              <option value="time">TIME (Earliest to Latest)</option>
              <option value="weekdays">WEEKDAYS</option>
              <option value="sat">SATURDAY</option>
              <option value="sun">SUNDAY</option>
          </select>
        </div>

        <div class="program-list">

            <div class="program-card">
                <div class="card-left">
                    <div class="title-status">
                        <h3>GOOD MORNING ENERGY</h3>
                        <span class="status offline">OFFLINE</span>
                    </div>
                    <p class="schedule">12:00 AM – 5:00 AM | WEEKDAYS, SAT</p>
                    <p class="hosts">MUSIC ONLY</p>
                </div>

                <div class="card-right">
                    <p>An all-night musical journey for the late hours. This program provides a continuous stream of hits, 
                      creating a serene and dreamlike atmosphere as the city rests.</p>
                </div>
            </div>

        </div>
    </section>

    <div class = "footer">
        <footer>Privacy Policy | Energy FM © 2025</footer>
    </div>

    <script>
      function formatToAMPM(time24) {
        const [hour, minute] = time24.split(':');
        const h = (hour % 12) || 12;
        return `${h}:${minute} ${hour >= 12 ? 'PM' : 'AM'}`;
      }

      function isProgramOnline(days, startT, endT) {
        const now = new Date();
        const [startHour, startMinute] = startT.split(':').map(Number);
        const [endHour, endMinute] = endT.split(':').map(Number);

        const start = new Date(now); start.setHours(startHour, startMinute, 0);
        const end = new Date(now);   end.setHours(endHour, endMinute, 0);
        if (end < start) end.setDate(end.getDate() + 1); // spans midnight

        const map = { WEEKDAYS:[1,2,3,4,5], SAT:[6], SUN:[0] };
        const correctDay = days.some(d => map[d]?.includes(now.getDay()));

        return now >= start && now <= end && correctDay;
      }

      Promise.all([
        fetch('http://localhost:5500/programs').then(r=>r.json()),
        fetch('http://localhost:5500/program_day_type').then(r=>r.json()),
        fetch('http://localhost:5500/daytype').then(r=>r.json()),
        fetch('http://localhost:5500/program_anchor_assignment').then(r=>r.json()),
        fetch('http://localhost:5500/djs').then(r=>r.json())
      ]).then(([programs, programDayTypes, dayTypes, assignments, djs]) => {

        const list = document.querySelector('.program-list');

        const timeToSec = t => {
          const [h,m,s] = t.split(':').map(Number);
          return (h||0)*3600 + (m||0)*60 + (s||0);
        };

        const getDays = id =>
          programDayTypes
            .filter(p=>p.PROGRAM_ID===id)
            .map(p=>dayTypes.find(d=>d.ID===p.DAY_TYPE_ID)?.DAY_TYPE);

        const getDJs = id =>
          assignments.filter(a=>a.PROGRAM_ID===id)
                    .map(a=>{
                      const dj=djs.find(d=>d.ID===a.DJ_ID);
                      return dj?.STAGE_NAME || dj?.REAL_NAME?.toUpperCase();
                    }).join(', ');

        function render(filter='title'){
          list.innerHTML = '';
          let data = [...programs];

          //  Filtering (no more show all — default is A-Z)
          if(['weekdays','sat','sun'].includes(filter)){
            const map={weekdays:'WEEKDAYS',sat:'SAT',sun:'SUN'};
            data = data.filter(p => getDays(p.ID).includes(map[filter]));
          }

          // Sorting
          // Sorting
if (filter === 'time' || ['weekdays', 'sat', 'sun'].includes(filter)) {
    data.sort((a, b) => timeToSec(a.START_TIME) - timeToSec(b.START_TIME)); // sort by time
} else {
    data.sort((a,b)=> (a.TITLE||'').localeCompare(b.TITLE||'')); // A–Z
}


          data.forEach(p=>{
            const days = getDays(p.ID);
            const djsList = getDJs(p.ID);
            const online = isProgramOnline(days,p.START_TIME,p.END_TIME);

            list.innerHTML += `
            <div class="program-card">
              <div class="card-left">
                <div class="title-status">
                  <h3>${p.TITLE}</h3>
                  <span class="status ${online?'online':'offline'}">${online?'ON AIR':'OFFLINE'}</span>
                </div>
                <p class="schedule">${formatToAMPM(p.START_TIME)}–${formatToAMPM(p.END_TIME)} | ${days.join(', ')}</p>
                <p class="hosts">${djsList || p.TYPE}</p>
              </div>
              <div class="card-right">
                <p>${p.DESCRIPTION || 'Program description here'}</p>
              </div>
            </div>`;
          });
        }

        render('title');

        document.getElementById('filter-select').addEventListener('change', e => render(e.target.value));
    })
        .catch(err => console.error(err));
    </script>
</body>
</html>