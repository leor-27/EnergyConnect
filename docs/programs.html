<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Programs</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="header">
        <a href = "home.html">
            <img src = "images/logo.png" alt = "Energy FM 106.3 Naga Logo" class = "logo">
        </a>

        <input type="checkbox" id="menu-toggle">
        <label for="menu-toggle" class="menu-icon">&#9776;</label>

        <div class="dropdown-menu">
            <a href="about.html">About</a>
            <a href="profiles.html">Profiles</a>
            <a href="programs.html">Programs</a>
            <a href="stream.html">Stream</a>
            <a href="news.html">News</a>
        </div>

        <div class="header-overlay">
            <h1>ENERGY PROGRAMS</h1>
            <p class = "intro-programs">Pangga, may ENERGY ka pa ba? Tara na! Dive into the world of ENERGY FM where all your favorite programs are in ONE place!<br>
            From music that keeps you vibing to live broadcasts and talk shows that keep you company, everything is here. Check out each program's schedule and anchors so you'll always know what's airing next!</p>
        </div>
    </header>

    <div class = "break-box"></div>

    <section class="content">

        <div class="top-bar">
            <h2>ALL PROGRAMS</h2>

            <button class="filter-btn">
                TITLE ▼
            </button>
        </div>

        <div class="program-list">

            <div class="program-card">
                <div class="card-left">
                    <div class="title-status">
                        <h3>GOOD MORNING ENERGY</h3>
                        <span class="status offline">OFFLINE</span>
                    </div>
                    <p class="schedule">12:00 AM – 5:00 AM | WEEKDAYS, SAT</p>
                    <p class="hosts">MUSIC ONLY</p>
                </div>

                <div class="card-right">
                    <p>An all-night musical journey for the late hours. This program provides a continuous stream of hits, creating a serene and dreamlike atmosphere as the city rests.</p>
                </div>
            </div>

        </div>
    </section>

    <div class = "footer">
        <footer>Privacy Policy | Energy FM © 2010</footer>
    </div>

<script>
        function formatToAMPM(time24) {
    // time24 is like "14:30:45" or "08:05:00"
    const [hour, minute] = time24.split(':'); // ignore seconds
    const h = parseInt(hour) % 12 || 12; // 0 → 12
    const ampm = parseInt(hour) >= 12 ? 'PM' : 'AM';
    return `${h}:${minute} ${ampm}`;
    }
  function isProgramOnline(programDayTypes, startTime, endTime) {
    const now = new Date();

    const [startHour, startMinute] = startTime.split(':').map(Number);
    const [endHour, endMinute] = endTime.split(':').map(Number);

    const start = new Date(now);
    start.setHours(startHour, startMinute, 0, 0);

    const end = new Date(now);
    end.setHours(endHour, endMinute, 0, 0);

    // Handle midnight wrap
    if (end < start) end.setDate(end.getDate() + 1);

    const isWithinTime = now >= start && now <= end;

    // Map day type names to weekdays (0 = Sunday, 6 = Saturday)
    const daysMap = {
      "WEEKDAYS": [1, 2, 3, 4, 5],
      "SAT": [6],
      "SUN": [0],
    };

    // Check if any day type matches today
    const isCorrectDay = programDayTypes.some(dt => daysMap[dt]?.includes(now.getDay()));

    return isWithinTime && isCorrectDay;
  }

  Promise.all([
    fetch('http://localhost:5500/programs').then(res => res.json()),
    fetch('http://localhost:5500/program_day_type').then(res => res.json()), // fetch Program_Day_Type
    fetch('http://localhost:5500/daytype').then(res => res.json()),
    fetch('http://localhost:5500/program_anchor_assignment').then(res => res.json()),
    fetch('http://localhost:5500/djs').then(res => res.json())
  ])
  .then(([programs, programDayTypes, dayTypes, assignments, djs]) => {
    const programList = document.querySelector('.program-list');
    programList.innerHTML = '';

    programs.forEach(program => {
      // Get all day type IDs for this program
      const programDayTypeIDs = programDayTypes
        .filter(pdt => pdt.PROGRAM_ID === program.ID)
        .map(pdt => pdt.DAY_TYPE_ID);

      // Get corresponding day type names
      const programDayTypeNames = programDayTypeIDs.map(id => {
        const dt = dayTypes.find(d => d.ID === id);
        return dt ? dt.DAY_TYPE : '';
      });

      // Get all DJs assigned to this program
      const assignedDJs = assignments
        .filter(a => a.PROGRAM_ID === program.ID)
        .map(a => {
          const dj = djs.find(d => d.ID === a.DJ_ID);
          if (!dj) return "";
          return dj.STAGE_NAME || dj.REAL_NAME.toUpperCase();
        })
        .join(', ');

      const isOnline = isProgramOnline(programDayTypeNames, program.START_TIME, program.END_TIME);
      const statusClass = isOnline ? "online" : "offline";
      const statusText = isOnline ? "ON AIR" : "OFFLINE";

      const card = document.createElement('div');
      card.classList.add('program-card');
      card.innerHTML = `
        <div class="card-left">
          <div class="title-status">
            <h3>${program.TITLE}</h3>
            <span class="status ${statusClass}">${statusText}</span>
          </div>
          <p class="schedule">${formatToAMPM(program.START_TIME)} – ${formatToAMPM(program.END_TIME)} | ${programDayTypeNames.join(', ')}</p>
          <p class="hosts">${assignedDJs || program.TYPE}</p>
        </div>
        <div class="card-right">
          <p>${program.DESCRIPTION || 'Program description here'}</p>
        </div>
      `;
      programList.appendChild(card);
    });
  })
  .catch(err => console.error(err));
</script>
</body>
</html>
